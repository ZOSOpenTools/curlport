export ZOPEN_BUILD_LINE="STABLE" # Default build line

export ZOPEN_STABLE_URL="https://curl.se/download/curl-8.2.1.tar.gz"
export ZOPEN_STABLE_DEPS="curl gzip tar make m4 perl autoconf openssl zlib gawk zoslib python"

export ZOPEN_DEV_URL="https://github.com/curl/curl.git"
export ZOPEN_DEV_DEPS="libtool automake curl gzip tar make m4 perl autoconf openssl zlib gawk zoslib python"

export ZOPEN_EXTRA_CPPFLAGS="-I\$OPENSSL_HOME/include -I\$ZLIB_HOME/include"
export LDFLAGS="-L\$OPENSSL_HOME/lib -L\$ZLIB_HOME/lib -lcrypto -lssl -lz"

zopen_post_buildenv()
{
  if [ "${ZOPEN_BUILD_LINE}x" = "DEVx" ]; then
    export ZOPEN_BOOTSTRAP="./buildconf"
  fi
}


export ZOPEN_EXTRA_CONFIGURE_OPTS="--with-openssl=\$OPENSSL_HOME"

# Requires impacket for tests
zopen_init()
{
  if ! ( pip3 freeze | grep -q impacket ); then
    pip3 install impacket 
  fi
  export PATH=${HOME}/.local/bin:$PATH
}

zopen_check_results()
{
chk="$1/$2_check.log"

success=$(grep -E "TESTDONE:.*tests out of.*reported OK" ${chk} | cut -f2 -d' ')
totalTests=$(grep -E "TESTDONE:.*tests out of.*reported OK" ${chk} | cut -f6 -d' ')
failures=$((totalTests-success))

cat <<ZZ
actualFailures:$failures
totalTests:$totalTests
expectedFailures:18
ZZ
}

zopen_append_to_env()
{
cat <<EOF
if [ "\${SSL_CERT_FILE}x" = "x" ]; then
  if [ -f "\$PWD/cacert.pem" ]; then
    export SSL_CERT_FILE="\$PWD/cacert.pem"
  else
    echo "Warning: you need to set SSL_CERT_FILE to a pem file if you want to use curl with SSH" >&2
  fi
fi
EOF
}

zopen_append_to_zoslib_env() {
cat <<EOF
SSL_CERT_FILE|set|PROJECT_ROOT/cacert.pem
EOF
}

zopen_post_install()
{
  # Install a cacert.pem to be used (optionally) by the customer
  zopen update-cacert -f $1
}

zopen_get_version()
{
  ./src/curl --version | cut -f2 -d' ' | head -1
}
